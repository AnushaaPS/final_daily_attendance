<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HoD Dashboard – Attendance & Management</title>
  <script src="common.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #eef3ff, #f7f9ff);
      margin: 0;
      padding: 15px;
      color: #1e293b;
    }

    h2 {
      text-align: center;
      color: #1e3a8a;
      margin-top: 10px;
      font-size: 1.6em;
    }

    .section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      padding: 15px 20px;
      margin: 20px auto;
      max-width: 1000px;
    }

    .section h3 {
      color: #1d4ed8;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    button, input, select {
width:80%;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95em;
    }

    .btn {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: 0.25s;
    }

    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 10px rgba(37, 99, 235, 0.4);
    }

    .logout-btn {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
    }

    #summaryGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      width: 180px;
      text-align: center;
      transition: 0.25s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }

    th {
      background: #1e3a8a;
      color: white;
    }

    .file-input {
      margin: 10px 0;
    }

    /* Popup modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 95%;
      max-width: 450px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .close-btn {
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      float: right;
      cursor: pointer;
    }
    /* === HEADER BAR STYLE === */
.topbar {
  background: linear-gradient(90deg, #1e3a8a, #2563eb);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  border-radius: 10px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  flex-wrap: wrap;
}

.topbar .title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.2em;
  font-weight: 600;
}

.topbar .title i {
  font-size: 1.4em;
  color: #ffffff;
}

.logout-btn {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 500;
  cursor: pointer;
  transition: 0.2s;
}

.logout-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
}

/* === MOBILE RESPONSIVE HEADER === */
@media (max-width: 768px) {
    .section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      padding: 15px 20px;
      margin: 20px auto;
      max-width: 100%;
    }
    
  .topbar {
    flex-direction: column;
    text-align: center;
    gap: 10px;
  }
  .logout-btn {
    width: 90%;
    font-size: 1em;
  }
}


    /* Responsive layout */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .section { padding: 12px; }
      h2 { font-size: 1.3em; }
      button, input, select { width: 100%; margin: 5px 0; font-size: 1em; }
      .filters { display: flex; flex-direction: column; align-items: stretch; }
      .card { width: 100%; max-width: 300px; }
      table, th, td { font-size: 0.85em; }
    }
  </style>
</head>

<body onload="initHOD()">

  <header class="topbar">
  <div class="title">
    <i class="fa-solid fa-user-tie"></i>
    <span>HoD Dashboard – Department: <strong id="hodDept"></strong></span>
  </div>
  <button class="btn logout-btn" onclick="logout()">
    <i class="fa-solid fa-right-from-bracket"></i> Logout
  </button>
</header>

  <!-- Attendance Summary -->
  <div class="section">
    <h3><i class="fa-solid fa-chart-pie"></i> Attendance Summary</h3>
    <div class="filters">
      <label><i class="fa-solid fa-calendar-days"></i> Date:
        <input type="date" id="date">
      </label>
      <label><i class="fa-solid fa-clock"></i> Batch:
        <select id="batch">
          <option value="FN">FN</option>
          <option value="AN">AN</option>
        </select>
      </label>
      <div>
        <button class="btn" onclick="loadSummary()"><i class="fa-solid fa-sync"></i> Load</button>
        <button class="btn" onclick="downloadSummaryCSV()"><i class="fa-solid fa-file-csv"></i> Class Summary</button>
        <button class="btn" onclick="downloadStudentwiseCSV()"><i class="fa-solid fa-user-graduate"></i> Student Report</button>
        
      </div>
    </div>
    <div id="summaryGrid"></div>
  </div>

  <!-- Search student history -->
  <div class="section">
    <h3><i class="fa-solid fa-user-clock"></i> Student Attendance History</h3>
    <input type="text" id="rollSearch" placeholder="Enter Roll No" />
    <button class="btn" onclick="viewStudentHistory()"><i class="fa-solid fa-eye"></i> View History</button>
  </div>

  <!-- Manage Faculty Users -->
  <div class="section">
    <h3><i class="fa-solid fa-users-gear"></i> Faculty Users</h3>
    <div style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;">
      <button class="btn" onclick="downloadUsersTemplate()"><i class="fa-solid fa-download"></i> Template</button>
      <input type="file" id="usersFile" class="file-input" accept=".csv">
      <button class="btn" onclick="uploadUsers()"><i class="fa-solid fa-upload"></i> Upload</button>
    </div>
    <table id="usersTable">
      <thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Upload Students -->
  <div class="section">
    <h3><i class="fa-solid fa-user-group"></i> Upload Students List</h3>
    <div style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;">
      <button class="btn" onclick="downloadStudentsTemplate()"><i class="fa-solid fa-download"></i> Template</button>
      <input type="file" id="studentsFile" class="file-input" accept=".csv">
      <button class="btn" onclick="uploadStudents()"><i class="fa-solid fa-upload"></i> Upload</button>
    </div>
  </div>

  <!-- Student History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeHistory()"><i class="fa-solid fa-xmark"></i></button>
      <h3 id="historyTitle"></h3>
      <table>
        <thead><tr><th>Date</th><th>Batch</th><th>Status</th><th>Reason</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
      <div id="historySummary" style="text-align:center; margin-top:10px; font-weight:600;"></div>
    </div>
  </div>

  <!-- Your existing JS logic -->


  <script>
    let hodDept = "";
    let absentees = [];

    /* === INIT === */
    function initHOD() {
      const user = requireRole("HoD");
      if(!user) return;
      hodDept = user.department;
      document.getElementById("hodDept").innerText = hodDept;

      loadFacultyUsers();
    }

    /* === Load Attendance Summary === */
let summaryData = {}; // ✅ global variable to store the same summary shown on screen

/* === Load Attendance Summary === */
async function loadSummary() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date");

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "getAbsenteesForHoD",
        department: hodDept,
        date, batch
      }),
    });
    const data = await res.json();

    if (!data || !data.success) {
      document.getElementById("summaryGrid").innerHTML =
        `<div style="color:red;text-align:center;">${data.message || "No attendance data found for this date & batch."}</div>`;
      return;
    }

    absentees = data.records || [];
    summaryData = data.summary || {};
    renderSummaryGrid(summaryData);

  } catch (err) {
    console.error(err);
    alert("Error loading summary. Please check your internet or backend script.");
  }
}

/* === Render Summary Grid === */
function renderSummaryGrid(summary) {
  const div = document.getElementById("summaryGrid");
  div.innerHTML = "";

  if (!summary || Object.keys(summary).length === 0) {
    div.innerHTML = `<div style="color:red; text-align:center;">No data found.</div>`;
    return;
  }

  Object.entries(summary).forEach(([key, s]) => {
    const [year, section] = key.split("_");
    const total = s.total || 0;
    const present = s.present || 0;
    const absent = s.absent || 0;
    const od = s.od || 0;
    const percent = total > 0 ? ((present / total) * 100).toFixed(2) : "0.00";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h4>${year} ${section}</h4>
      <p><strong>Total:</strong> ${total}</p>
      <p style="color:green;"><strong>Present:</strong> ${present}</p>
      <p style="color:red;"><strong>Absent:</strong> ${absent}</p>
      <p style="color:#eab308;"><strong>OD:</strong> ${od}</p>
      <p><strong>Attendance %:</strong> ${percent}%</p>
    `;
    div.appendChild(card);
  });
}

/* === Download Class Summary CSV === */
function downloadSummaryCSV() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date || !batch) return alert("Please select both date and batch!");
  if (!summaryData || Object.keys(summaryData).length === 0)
    return alert("No summary data to download.");

  const header = ["Year","Section","Total Students","Present","Absent","OD","Attendance %"];
  let csv = header.join(",") + "\n";

  Object.entries(summaryData).forEach(([key, c]) => {
    const [year, section] = key.split("_");
    const total = c.total || 0;
    const present = c.present || 0;
    const absent = c.absent || 0;
    const od = c.od || 0;
    const percent = total > 0 ? ((present / total) * 100).toFixed(2) : "0.00";
    csv += [year, section, total, present, absent, od, `${percent}%`].join(",") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `ClassSummary_${hodDept}_${date}_${batch}.csv`;
  a.click();
}

/* === Download Studentwise Absent/OD CSV === */
function downloadStudentwiseCSV() {
  if (!absentees.length) return alert("No data to download");
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  const filtered = absentees.filter(
    (s) => s.Status === "Absent" || s.Status === "OD"
  );
  if (!filtered.length)
    return alert("No absent/OD records found for the selected date & batch.");

  const header = [
    "RollNo",
    "Name",
    "Year",
    "Section",
    "Status",
    "Reason",
  ];
  let csv = header.join(",") + "\n";
  filtered.forEach((s) => {
    csv +=
      [s.RollNo, s.Name, s.Year, s.Section, s.Status, s.Reason || ""].join(
        ","
      ) + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Studentwise_Absent_OD_${hodDept}_${date}_${batch}.csv`;
  a.click();
}

    /* === Student History Popup === */
    async function viewStudentHistory(){
      const rollNo=document.getElementById("rollSearch").value.trim();
      if(!rollNo) return alert("Enter Roll No");
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"getStudentHistory", rollNo})
      });
      const data=await res.json();
      if(!data.success) return alert(data.message);

      const records=data.records;
      const body=document.getElementById("historyBody");
      const title=document.getElementById("historyTitle");
      const summary=document.getElementById("historySummary");
      body.innerHTML="";
      if(!records.length){
        title.innerText=`No history found for ${rollNo}`;
        document.getElementById("historyModal").style.display="flex";
        return;
      }
      title.innerText=`History of ${rollNo}`;
      let absentCount=0, odCount=0;
      records.forEach(r=>{
        if(r.Status==="Absent") absentCount++;
        if(r.Status==="OD") odCount++;
        body.innerHTML+=`<tr><td>${r.Date}</td><td>${r.Batch}</td><td>${r.Status}</td><td>${r.Reason||""}</td></tr>`;
      });
      summary.innerHTML=`Total: ${records.length} | Absent: ${absentCount} | OD: ${odCount}`;
      document.getElementById("historyModal").style.display="flex";
    }

    function closeHistory(){
      document.getElementById("historyModal").style.display="none";
    }

    /* === Faculty Users === */
    async function loadFacultyUsers(){
      const res = await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"getUsersByDept", department: hodDept, role:"Faculty"})
      });
      const data = await res.json();
      if(!data.success) return alert(data.message);
      const tbody=document.querySelector("#usersTable tbody");
      tbody.innerHTML="";
      data.users.forEach(u=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${u.Email}</td><td>${u.Name}</td><td>${u.Role}</td>
          <td><button class="btn" onclick="deleteUser('${u.Email}')">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function downloadUsersTemplate(){
      const csv="Email,Password,Name,Role,Department,Year,Section\nexample@domain.com,123456,John Doe,Faculty,"+hodDept+",IV,C";
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="UsersTemplate.csv";
      a.click();
    }

    async function uploadUsers(){
      const file=document.getElementById("usersFile").files[0];
      if(!file) return alert("Select CSV file");
      const text=await file.text();
      const lines=text.split("\n").filter(l=>l.trim());
      const users=lines.slice(1).map(l=>{
        const [Email,Password,Name,Role,Department,Year,Section]=l.split(",");
        return {Email,Password,Name,Role,Department,Year,Section};
      });
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"uploadUsers", users})
      });
      const data=await res.json();
      alert(data.message);
      loadFacultyUsers();
    }

    async function deleteUser(email){
      if(!confirm("Delete this user?")) return;
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"deleteUser", email})
      });
      const data=await res.json();
      alert(data.message);
      loadFacultyUsers();
    }

    /* === Students Upload === */
    function downloadStudentsTemplate(){
      const csv="RollNo,Name,ParentName,ParentPhone,Department,Year,Section\n101,John Doe,Jane Doe,9876543210,"+hodDept+",IV,C";
      const blob=new Blob([csv],{type:"text/csv"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="StudentsTemplate.csv";
      a.click();
    }

    async function uploadStudents(){
      const file=document.getElementById("studentsFile").files[0];
      if(!file) return alert("Select CSV file");
      const text=await file.text();
      const lines=text.split("\n").filter(l=>l.trim());
      const students=lines.slice(1).map(l=>{
        const [RollNo,Name,ParentName,ParentPhone,Department,Year,Section]=l.split(",");
        return {RollNo,Name,ParentName,ParentPhone,Department,Year,Section};
      });
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify({action:"uploadStudents", students})
      });
      const data=await res.json();
      alert(data.message);
    }

  </script>
</body>
</html>






